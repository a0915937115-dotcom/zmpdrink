<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜­æ˜åœ‹å° VIPé»é¤ç³»çµ±</title>
    <script type="importmap">
    {
        "imports": {
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
        }
    }
    </script>
    <style>
        :root {
            --primary-yellow: #fdd835; /* åƒè€ƒæ‰“å¡ç‰†çš„äº®é»ƒè‰² */
            --primary-blue: #0056b3;   /* åƒè€ƒèœå–®çœ‹æ¿çš„è—è‰² */
            --bg: #f0f4f8;
            --text: #333;
        }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: var(--bg); margin: 0; padding: 15px; color: var(--text); }
        h1 { text-align: center; color: var(--primary-blue); margin-bottom: 5px; text-transform: uppercase; }
        .school-title { text-align: center; font-size: 1.1rem; color: #666; margin-bottom: 20px; font-weight: bold; }
        
        .container { width: 100%; max-width: 1250px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 0 auto; }
        @media (max-width: 1150px) { .container { grid-template-columns: 1fr; } }
        
        .card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); border-top: 8px solid var(--primary-yellow); position: relative; }
        .card.order-summary { border-top-color: var(--primary-blue); }
        .card.agg-summary { border-top-color: #2ecc71; }
        
        h2 { font-size: 1.3rem; margin-top: 0; display: flex; align-items: center; gap: 8px; color: var(--primary-blue); border-bottom: 2px solid #eee; padding-bottom: 10px; }
        label { display: block; margin: 15px 0 5px; font-weight: bold; font-size: 0.95rem; }
        
        select, input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; }
        select:focus { border-color: var(--primary-blue); outline: none; }
        
        .size-group { display: flex; gap: 10px; margin-top: 10px; }
        .size-btn { flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 10px; background: white; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .size-btn.active { background: var(--primary-blue); color: white; border-color: var(--primary-blue); }

        .btn-add { background: var(--primary-yellow); color: #000; border: none; width: 100%; padding: 16px; border-radius: 12px; font-size: 1.2rem; cursor: pointer; font-weight: bold; margin-top: 25px; box-shadow: 0 4px 0 #d4b400; }
        .btn-add:active { transform: translateY(2px); box-shadow: none; }
        
        .list-container { flex-grow: 1; overflow-y: auto; max-height: 450px; margin-top: 10px; }
        .order-item { background: #f9f9f9; border-radius: 12px; padding: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid var(--primary-blue); }
        .agg-item { background: #eef9f2; border-radius: 12px; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; border-left: 5px solid #2ecc71; }
        .count-badge { background: #2ecc71; color: white; padding: 2px 12px; border-radius: 15px; font-weight: bold; }
        
        .delete-btn { background: #fff1f1; color: #e74c3c; border: 1px solid #e74c3c; border-radius: 8px; padding: 6px 12px; cursor: pointer; font-size: 0.8rem; }
        .summary-box { background: #fffbe6; padding: 15px; border-radius: 12px; border: 1px dashed #ffe58f; margin: 15px 0; font-size: 0.9rem; white-space: pre-wrap; }
        .status-dot { width: 10px; height: 10px; background: #2ecc71; border-radius: 50%; display: inline-block; margin-right: 5px; }
    </style>
</head>
<body>

<h1>ğŸ« æ˜­æ˜åœ‹å°-VIPé»é¤ç³»çµ±</h1>
<div class="school-title">ZHAOMING ELEMENTARY SCHOOL - VIP ORDERING</div>
<div style="text-align: center; font-size: 12px; color: #999; margin-bottom: 15px;">
    <span class="status-dot"></span><span id="status">åŒæ­¥ä¸­... Syncing...</span>
</div>

<div class="container">
    <div class="card">
        <h2>âœï¸ å¡«å¯«é»å–® Order</h2>
        <label>å§“å Name</label>
        <input type="text" id="name" placeholder="è«‹è¼¸å…¥é»é¤äººå§“å">

        <label>ç³»åˆ— Category</label>
        <select id="category" onchange="updateDrinks()">
            <option value="">-- è«‹é¸æ“‡ç³»åˆ— --</option>
            <option value="tea">ğŸƒ æ‰¾å¥½èŒ¶ Classic Tea</option>
            <option value="milkTea">ğŸ§‹ æ‰¾å¥¶èŒ¶ Milk Tea</option>
            <option value="fresh">ğŸ‹ æ‰¾æ–°é®® Juice & Fruit</option>
            <option value="latte">ğŸ¥› æ‰¾æ‹¿éµ Tea Latte</option>
            <option value="iceCream">ğŸ¦ æ‰¾å†°æ·‡æ·‹ Ice Cream</option>
        </select>

        <label>é£²å“åç¨± Drink</label>
        <select id="drinkSelect" onchange="updatePrice()"><option value="">è«‹å…ˆé¸æ“‡ç³»åˆ—</option></select>

        <label>è¦æ ¼ Size</label>
        <div class="size-group">
            <button class="size-btn active" id="btnM" onclick="setSize('M')">ä¸­æ¯ (M)</button>
            <button class="size-btn" id="btnL" onclick="setSize('L')">å¤§æ¯ (L)</button>
        </div>

        <div style="display: flex; gap: 10px;">
            <div style="flex: 1;"><label>ç”œåº¦ Sugar</label><select id="sugar"><option>ç„¡ç³– 0%</option><option>å¾®ç³– 30%</option><option>åŠç³– 50%</option><option>å°‘ç³– 70%</option><option>æ­£å¸¸ 100%</option></select></div>
            <div style="flex: 1;"><label>å†°å¡Š Ice</label><select id="ice"><option>å»å†° No</option><option>å¾®å†° Low</option><option>å°‘å†° Less</option><option>æ­£å¸¸ Normal</option><option>å¸¸æº« Room</option><option>ç†± Hot</option></select></div>
        </div>

        <button class="btn-add" id="submitBtn">é€å‡ºè¨‚å–® ($<span id="displayPrice">0</span>)</button>
    </div>

    <div class="card order-summary">
        <h2>ğŸ“‹ å€‹äººæ˜ç´° Details <span id="count" style="font-size: 14px; margin-left: 8px;">(0æ¯)</span></h2>
        <div class="list-container" id="orderList"></div>
        <div class="summary-box" id="summaryOutput">ç›®å‰å°šç„¡é»é¤è³‡æ–™</div>
        <button style="width:100%; padding:12px; background: var(--primary-blue); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:bold;" onclick="copySummary()">è¤‡è£½ LINE çµ±è¨ˆæ ¼å¼</button>
    </div>

    <div class="card agg-summary">
        <h2>ğŸ“Š å“é …çµ±è¨ˆ Summary</h2>
        <div class="list-container" id="aggList"><p style="color: #999; text-align: center; margin-top: 20px;">ç­‰å¾…è¨‚å–®ä¸­...</p></div>
        <div style="margin-top: auto; padding-top: 15px; border-top: 2px solid #eee; text-align: right;">
            <h3 style="margin: 0;">ç¸½è¨ˆ: <span style="color:var(--primary-blue); font-size: 1.8rem;">$<span id="totalPrice">0</span></span></h3>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "firebase/app";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc } from "firebase/firestore";

    const firebaseConfig = {
      apiKey: "AIzaSyC5hY6aKGzpwD4Cp8fafE4hUwvC7KEvWFc",
      authDomain: "drin-296d7.firebaseapp.com",
      projectId: "drin-296d7",
      storageBucket: "drin-296d7.firebasestorage.app",
      messagingSenderId: "138452108599",
      appId: "1:138452108599:web:aa9089dba15317e8cd46b2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const ordersRef = collection(db, "orders_list");

    let currentSize = 'M';
    const menu = {
        tea: [
            {n:"èŒ‰è‰ç¶ èŒ¶ Jasmine Green", m:25, l:30}, {n:"é˜¿è–©å§†ç´…èŒ¶ Assam Black", m:25, l:30}, {n:"å››å­£æ˜¥é’èŒ¶ 4 Seasons", m:25, l:30}, 
            {n:"é»ƒé‡‘çƒé¾ Golden Oolong", m:25, l:30}, {n:"1è™Ÿ(å››å­£æ˜¥çæ³¢æ¤°) #1 Special", m:35, l:45}, {n:"æ³¢éœ¸ç¶ /ç´… Bubble Green/Black", m:35, l:45},
            {n:"å¾®æª¸æª¬ç´…/é’ Lemon Tea", m:35, l:45}, {n:"æª¸æª¬ç¶ /é’ Lemon Green", m:40, l:55}, {n:"æ¢…ã®ç¶  Plum Green", m:40, l:55},
            {n:"8å†°ç¶  No.8 Green Tea", m:40, l:55}, {n:"å¤šå¤šç¶  Yakult Green", m:40, l:55}, {n:"æ—ºä¾†ç´… Pineapple Black", m:40, l:55},
            {n:"æŸšå­ç´… Grapefruit Black", m:40, l:55}, {n:"é®®æŸšç¶  Grapefruit Green", m:50, l:65}
        ],
        milkTea: [
            {n:"å¥¶èŒ¶ Milk Tea", m:40, l:55}, {n:"å¥¶ç¶  Green Milk Tea", m:40, l:55}, {n:"çƒé¾å¥¶ Oolong Milk Tea", m:40, l:55},
            {n:"çç å¥¶èŒ¶ Pearl Milk Tea", m:40, l:55}, {n:"æ³¢éœ¸å¥¶èŒ¶ Bubble Milk Tea", m:40, l:55}, {n:"ç‡•éº¥å¥¶èŒ¶ Oatmeal Milk Tea", m:40, l:55},
            {n:"æ¤°æœå¥¶èŒ¶ Coconut Milk Tea", m:40, l:55}, {n:"é˜¿è¯ç”° Ovaltine", m:40, l:55}
        ],
        fresh: [
            {n:"8å†°èŒ¶ No.8 Iced Tea", m:40, l:55}, {n:"æŸšå­èŒ¶ Grapefruit Tea", m:40, l:55}, {n:"æª¸æª¬æ± Lemon Juice", m:50, l:65},
            {n:"è‘¡è„æŸšæ± Grapefruit Juice", m:50, l:65}, {n:"é‡‘æ¡”æª¸æª¬ Kumquat Lemon", m:50, l:65}, {n:"æª¸æª¬æ¢…æ± Lemon Plum", m:50, l:65},
            {n:"æª¸æª¬å¤šå¤š Lemon Yakult", m:55, l:75}, {n:"è‘¡è„æŸšå¤šå¤š Grapefruit Yakult", m:55, l:75}
        ],
        latte: [
            {n:"ç´…èŒ¶æ‹¿éµ Black Tea Latte", m:50, l:65}, {n:"çç ç´…èŒ¶æ‹¿éµ Pearl Latte", m:50, l:65}, {n:"æ³¢éœ¸ç´…èŒ¶æ‹¿éµ Bubble Latte", m:50, l:65},
            {n:"ç‡•éº¥ç´…èŒ¶æ‹¿éµ Oatmeal Latte", m:50, l:65}, {n:"é˜¿è¯ç”°æ‹¿éµ Ovaltine Latte", m:50, l:65}
        ],
        iceCream: [
            {n:"å†°æ·‡æ·‹ç´…èŒ¶ Ice Cream Black Tea", m:40, l:55}, {n:"èŠ’æœé’ Mango Green Tea", m:40, l:55}, {n:"è”æçƒé¾ Lychee Oolong", m:40, l:55},
            {n:"å†°æ·‡æ·‹å¥¶èŒ¶ Ice Cream Milk Tea", m:50, l:65}, {n:"å†°æ·‡æ·‹ç´…èŒ¶æ‹¿éµ Ice Cream Latte", m:55, l:75}
        ]
    };

    window.setSize = (s) => {
        currentSize = s;
        document.getElementById('btnM').className = s === 'M' ? 'size-btn active' : 'size-btn';
        document.getElementById('btnL').className = s === 'L' ? 'size-btn active' : 'size-btn';
        updatePrice();
    };

    window.updateDrinks = () => {
        const cat = document.getElementById('category').value;
        const drinkSelect = document.getElementById('drinkSelect');
        drinkSelect.innerHTML = '<option value="">-- è«‹é¸æ“‡é£²å“ --</option>';
        if (cat && menu[cat]) {
            menu[cat].forEach((item, index) => {
                let opt = document.createElement('option');
                opt.value = index;
                opt.textContent = item.n;
                drinkSelect.appendChild(opt);
            });
        }
        updatePrice();
    };

    window.updatePrice = () => {
        const cat = document.getElementById('category').value;
        const idx = document.getElementById('drinkSelect').value;
        const priceSpan = document.getElementById('displayPrice');
        if (cat && idx !== "") {
            const price = currentSize === 'M' ? menu[cat][idx].m : menu[cat][idx].l;
            priceSpan.innerText = price;
        } else {
            priceSpan.innerText = "0";
        }
    };

    document.getElementById('submitBtn').onclick = async () => {
        const name = document.getElementById('name').value;
        const cat = document.getElementById('category').value;
        const idx = document.getElementById('drinkSelect').value;
        if (!name || idx === "") return alert("è«‹è¼¸å…¥å§“åä¸¦é¸æ“‡é£²å“ï¼");
        
        const item = menu[cat][idx];
        const price = currentSize === 'M' ? item.m : item.l;
        
        await addDoc(ordersRef, {
            name: name,
            drink: item.n,
            spec: `${currentSize} / ${document.getElementById('sugar').value} / ${document.getElementById('ice').value}`,
            price: price,
            createdAt: new Date()
        });
        document.getElementById('name').value = "";
    };

    onSnapshot(query(ordersRef, orderBy("createdAt", "asc")), (snap) => {
        const listDiv = document.getElementById('orderList');
        const aggDiv = document.getElementById('aggList');
        listDiv.innerHTML = ''; aggDiv.innerHTML = '';
        let total = 0, count = 0, txt = "ã€æ˜­æ˜åœ‹å° VIP è¨‚å–®ã€‘\n", agg = {};

        snap.forEach(d => {
            const o = d.data(); const id = d.id;
            total += o.price; count++;
            listDiv.innerHTML += `<div class="order-item"><div><b>${o.name}</b><br><small>${o.drink}</small><br><small>${o.spec}</small></div><div style="text-align:right"><b>$${o.price}</b><br><button class="delete-btn" onclick="deleteItem('${id}','${o.name}')">åˆªé™¤</button></div></div>`;
            txt += `${count}. ${o.name}: ${o.drink} (${o.spec}) $${o.price}\n`;
            const key = `${o.drink} [${o.spec.split(' / ')[0]}]\n(${o.spec.split(' / ').slice(1).join(' / ')})`;
            agg[key] = (agg[key] || 0) + 1;
        });

        if (count > 0) {
            Object.keys(agg).forEach(k => {
                aggDiv.innerHTML += `<div class="agg-item"><span>${k}</span><span class="count-badge">${agg[k]} æ¯</span></div>`;
            });
        } else { aggDiv.innerHTML = '<p style="text-align:center; color:#999; margin-top:20px;">å°šç„¡è¨‚å–®</p>'; }

        document.getElementById('totalPrice').innerText = total;
        document.getElementById('count').innerText = `(${count}æ¯)`;
        document.getElementById('summaryOutput').innerText = count > 0 ? txt + `\nç¸½è¨ˆ: ${count}æ¯ / $${total}` : "ç›®å‰ç„¡è¨‚å–®è³‡æ–™";
    });

    window.deleteItem = async (id, name) => { if (confirm(`ç¢ºå®šåˆªé™¤ ${name} çš„è¨‚å–®ï¼Ÿ`)) await deleteDoc(doc(db, "orders_list", id)); };
    window.copySummary = () => { navigator.clipboard.writeText(document.getElementById('summaryOutput').innerText); alert("çµ±è¨ˆæ–‡å­—å·²è¤‡è£½ï¼"); };
</script>
</body>
</html>
