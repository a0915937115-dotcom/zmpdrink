<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜­æ˜åœ‹å° VIPé»é¤ç³»çµ±</title>
    <script type="importmap">
    {
        "imports": {
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
        }
    }
    </script>
    <style>
        :root {
            --primary: #4ecdc4; /* è–„è·ç¶  */
            --secondary: #ff9f43; /* æš–é™½æ©˜ */
            --accent: #6c5ce7; /* çµ±è¨ˆç´« */
            --bg: #f7f9fc;
            --text: #2c3e50;
        }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: var(--bg); margin: 0; padding: 15px; color: var(--text); }
        h1 { text-align: center; color: var(--text); margin-bottom: 5px; }
        .school-title { text-align: center; font-size: 1.1rem; color: #777; margin-bottom: 20px; letter-spacing: 1px; }
        
        /* ä½ˆå±€è¨­è¨ˆï¼šä¸‰æ¬„ */
        .container { 
            width: 100%; 
            max-width: 1250px; 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 15px; 
            margin: 0 auto; 
        }
        
        @media (max-width: 1150px) {
            .container { grid-template-columns: 1fr; }
        }
        
        .card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid #eee; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .card::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 6px; background: var(--primary); }
        .card.order-summary::before { background: var(--secondary); }
        .card.agg-summary::before { background: var(--accent); }
        
        h2 { font-size: 1.25rem; margin-top: 0; display: flex; align-items: center; gap: 8px; color: #444; }
        label { display: block; margin: 12px 0 5px; font-weight: 600; color: #555; font-size: 0.9rem; }
        
        select, input { width: 100%; padding: 12px; border: 2px solid #edf2f7; border-radius: 12px; font-size: 15px; transition: all 0.3s; box-sizing: border-box; }
        select:focus, input:focus { border-color: var(--primary); outline: none; }
        
        .btn-add { background: var(--primary); color: white; border: none; width: 100%; padding: 15px; border-radius: 12px; font-size: 1.1rem; cursor: pointer; font-weight: bold; margin-top: 20px; transition: 0.2s; }
        .btn-add:hover { opacity: 0.9; transform: translateY(-2px); }
        
        /* æ¸…å–®åˆ—è¡¨æ¨£å¼ */
        .list-container { flex-grow: 1; overflow-y: auto; max-height: 500px; padding-right: 5px; margin-top: 10px; }
        
        /* å€‹äººæ˜ç´°é …ç›® */
        .order-item { background: #fafafa; border-radius: 12px; padding: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid var(--secondary); font-size: 0.9rem; }
        .order-info b { color: var(--text); font-size: 1rem; }
        .order-info small { color: #888; display: block; margin-top: 2px; line-height: 1.3; }
        
        /* åŒ¯ç¸½é …ç›® */
        .agg-item { background: #f8f7ff; border-radius: 12px; padding: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid var(--accent); border-bottom: 1px solid #eee; }
        .agg-name { font-size: 0.9rem; font-weight: 500; color: #444; flex: 1; padding-right: 10px; }
        .agg-count { background: var(--accent); color: white; padding: 4px 12px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; min-width: 40px; text-align: center; }
        
        .delete-btn { background: #fff5f5; color: #ff5e5e; border: 1px solid #ff5e5e; border-radius: 8px; padding: 5px 10px; cursor: pointer; font-size: 0.8rem; }
        .delete-btn:hover { background: #ff5e5e; color: white; }
        
        .summary-box { background: #fffcf8; padding: 15px; border-radius: 12px; border: 1px dashed var(--secondary); margin: 15px 0; font-size: 0.85rem; white-space: pre-wrap; color: #666; }
        
        .footer-total { margin-top: auto; padding-top: 15px; border-top: 1px solid #eee; text-align: right; }
        .status-dot { width: 10px; height: 10px; background: #2ecc71; border-radius: 50%; display: inline-block; margin-right: 5px; }
    </style>
</head>
<body>

<h1>ğŸ« æ˜­æ˜åœ‹å°-VIPé»é¤ç³»çµ±</h1>
<div class="school-title">Zhaoming Elementary School - VIP Ordering</div>
<div style="text-align: center; font-size: 12px; color: #999; margin-bottom: 15px;">
    <span class="status-dot"></span><span id="status">æ­£åœ¨åŒæ­¥é›²ç«¯... Syncing...</span>
</div>

<div class="container">
    <div class="card">
        <h2>âœï¸ å¡«å¯« Order Form</h2>
        <label>é»é¤äººå§“å Name</label>
        <input type="text" id="name" placeholder="è«‹è¼¸å…¥å§“å">

        <label>é£²å“ç³»åˆ— Series</label>
        <select id="category" onchange="updateDrinks()">
            <option value="">-- è«‹é¸æ“‡ç³»åˆ— Select Series --</option>
            <option value="recommend">â­ åº—é•·æ¨è–¦ Top Picks</option>
            <option value="tea">ğŸƒ æ‰¾å¥½èŒ¶ Classic Tea</option>
            <option value="milkTea">ğŸ§‹ æ‰¾å¥¶èŒ¶ Milk Tea</option>
            <option value="fresh">ğŸ‹ æ‰¾æ–°é®® Juice & Fruit</option>
            <option value="latte">ğŸ¥› æ‰¾æ‹¿éµ Tea Latte</option>
            <option value="iceCream">ğŸ¦ æ‰¾å†°æ·‡æ·‹ Ice Cream</option>
        </select>

        <label>é£²å“åç¨± Drink</label>
        <select id="drinkSelect"><option value="">è«‹å…ˆé¸æ“‡ç³»åˆ— Select Series First</option></select>

        <div style="display: flex; gap: 10px;">
            <div style="flex: 1;">
                <label>ç”œåº¦ Sugar</label>
                <select id="sugar">
                    <option>ç„¡ç³– 0% Sugar</option><option>å¾®ç³– 30% Sugar</option><option>åŠç³– 50% Sugar</option><option>å°‘ç³– 70% Sugar</option><option>æ­£å¸¸ç³– 100% Sugar</option>
                </select>
            </div>
            <div style="flex: 1;">
                <label>å†°å¡Š Ice</label>
                <select id="ice">
                    <option>å»å†° No Ice</option><option>å¾®å†° Low Ice</option><option>å°‘å†° Less Ice</option><option>æ­£å¸¸å†° Normal Ice</option><option>å¸¸æº« Room Temp</option><option>ç†± Hot</option>
                </select>
            </div>
        </div>

        <button class="btn-add" id="submitBtn">é€å‡ºè¨‚å–® Submit Order</button>
    </div>

    <div class="card order-summary">
        <h2>ğŸ“‹ å€‹äººæ˜ç´° Details <span id="count" style="font-size: 14px; color: var(--secondary); margin-left: 8px;">(0æ¯)</span></h2>
        <div class="list-container" id="orderList"></div>
        
        <div class="summary-box" id="summaryOutput">ç›®å‰å°šç„¡é»é¤è³‡æ–™ No orders.</div>
        <button style="width:100%; padding:12px; background: var(--secondary); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:bold;" onclick="copySummary()">è¤‡è£½ LINE çµ±è¨ˆ Copy</button>
    </div>

    <div class="card agg-summary">
        <h2>ğŸ“Š å“é …åŒ¯ç¸½ Summary</h2>
        <div class="list-container" id="aggList">
            <p style="color: #999; font-size: 0.9rem; text-align: center; margin-top: 20px;">ç­‰å¾…è¨‚å–®åŒ¯ç¸½ä¸­...</p>
        </div>
        
        <div class="footer-total">
            <h3 style="margin: 0; color: #444;">ç¸½é‡‘é¡ Total: <span style="color:var(--accent); font-size: 1.6rem;">$<span id="totalPrice">0</span></span></h3>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "firebase/app";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc } from "firebase/firestore";

    // æ²¿ç”¨ä½ çš„ Firebase é…ç½®
    const firebaseConfig = {
      apiKey: "AIzaSyC5hY6aKGzpwD4Cp8fafE4hUwvC7KEvWFc",
      authDomain: "drin-296d7.firebaseapp.com",
      projectId: "drin-296d7",
      storageBucket: "drin-296d7.firebasestorage.app",
      messagingSenderId: "138452108599",
      appId: "1:138452108599:web:aa9089dba15317e8cd46b2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const ordersRef = collection(db, "orders_list");

    const menu = {
        recommend: [
            {n:"éºµèŒ¶ç´…èŒ¶æ‹¿éµ Flour Tea Black Tea Latte", p:75}, 
            {n:"å››å­£æ˜¥çæ³¢æ¤° 4 Seasons Tea w/Pearls", p:45}, 
            {n:"èŠ’æœé’ Mango Green Tea", p:55}, 
            {n:"è”æçƒé¾ Lychee Oolong Tea", p:55}, 
            {n:"é‡ç„™çƒé¾æ‹¿éµ Roasted Oolong Latte", p:65}
        ],
        tea: [
            {n:"èŒ‰è‰ç¶ èŒ¶ Jasmine Green Tea", p:30}, 
            {n:"é˜¿è–©å§†ç´…èŒ¶ Assam Black Tea", p:30}, 
            {n:"å››å­£æ˜¥é’èŒ¶ 4 Seasons Tea", p:30}, 
            {n:"é»ƒé‡‘çƒé¾ Golden Oolong Tea", p:30}, 
            {n:"æª¸æª¬ç¶ èŒ¶ Lemon Green Tea", p:55}, 
            {n:"é®®æŸšç¶  Grapefruit Green Tea", p:65}
        ],
        milkTea: [
            {n:"å¥¶ç¶  Green Milk Tea", p:55}, 
            {n:"å¥¶èŒ¶ Milk Tea", p:55}, 
            {n:"æ³¢éœ¸å¥¶èŒ¶ Bubble Milk Tea", p:55}, 
            {n:"éºµèŒ¶å¥¶èŒ¶ Flour Milk Tea", p:65}
        ],
        fresh: [
            {n:"æª¸æª¬æ± Lemon Juice", p:65}, 
            {n:"é‡‘æ¡”æª¸æª¬ Kumquat Lemon", p:65}, 
            {n:"æª¸æª¬å¤šå¤š Lemon Yakult", p:75}, 
            {n:"8å†°èŒ¶ No.8 Iced Tea", p:55}
        ],
        latte: [
            {n:"ç´…èŒ¶æ‹¿éµ Black Tea Latte", p:65}, 
            {n:"æ³¢éœ¸ç´…èŒ¶æ‹¿éµ Bubble Black Tea Latte", p:65}, 
            {n:"ç‡•éº¥é®®å¥¶ Oatmeal Fresh Milk", p:75}
        ],
        iceCream: [
            {n:"å†°æ·‡æ·‹ç¶ èŒ¶ Ice Cream Green Tea", p:55}, 
            {n:"å†°æ·‡æ·‹å¥¶èŒ¶ Ice Cream Milk Tea", p:65}, 
            {n:"å†°æ·‡æ·‹é®®å¥¶ Ice Cream Fresh Milk", p:85}
        ]
    };

    window.updateDrinks = () => {
        const cat = document.getElementById('category').value;
        const drinkSelect = document.getElementById('drinkSelect');
        drinkSelect.innerHTML = '<option value="">-- è«‹é¸æ“‡é£²å“ --</option>';
        if (cat && menu[cat]) {
            menu[cat].forEach(item => {
                let opt = document.createElement('option');
                opt.value = item.p;
                opt.textContent = `${item.n} ($${item.p})`;
                drinkSelect.appendChild(opt);
            });
        }
    };

    window.deleteItem = async (id, name) => {
        if (confirm(`ç¢ºå®šè¦åˆªé™¤ ${name} çš„è¨‚å–®å—ï¼Ÿ`)) {
            await deleteDoc(doc(db, "orders_list", id));
        }
    };

    document.getElementById('submitBtn').onclick = async () => {
        const name = document.getElementById('name').value;
        const drinkNode = document.getElementById('drinkSelect');
        if (!name || drinkNode.value === "") return alert("è«‹è¼¸å…¥å§“åèˆ‡é£²å“ï¼");
        
        await addDoc(ordersRef, {
            name: name,
            drink: drinkNode.options[drinkNode.selectedIndex].text.split(' ($')[0],
            spec: `${document.getElementById('sugar').value} / ${document.getElementById('ice').value}`,
            price: parseInt(drinkNode.value),
            createdAt: new Date()
        });
        document.getElementById('name').value = "";
    };

    onSnapshot(query(ordersRef, orderBy("createdAt", "asc")), (snap) => {
        document.getElementById('status').innerText = "ğŸŸ¢ é›²ç«¯åŒæ­¥ä¸­ Connected";
        const listDiv = document.getElementById('orderList');
        const aggDiv = document.getElementById('aggList');
        listDiv.innerHTML = '';
        aggDiv.innerHTML = '';
        
        let total = 0, count = 0, txt = "ã€æ˜­æ˜åœ‹å° VIP è¨‚å–®çµ±è¨ˆã€‘\n";
        let aggregation = {}; 

        snap.forEach(docSnap => {
            const o = docSnap.data();
            const id = docSnap.id;
            total += o.price; count++;
            
            // æ¸²æŸ“æ˜ç´°
            listDiv.innerHTML += `
                <div class="order-item">
                    <div class="order-info"><b>${o.name}</b><small>${o.drink}</small><small>${o.spec}</small></div>
                    <div style="text-align:right">
                        <div style="font-weight:bold; color:var(--secondary); margin-bottom:5px;">$${o.price}</div>
                        <button class="delete-btn" onclick="deleteItem('${id}', '${o.name}')">åˆªé™¤</button>
                    </div>
                </div>`;
            txt += `${count}. ${o.name}: ${o.drink} (${o.spec})\n`;

            // çµ±è¨ˆåŒ¯ç¸½é‚è¼¯
            const key = `${o.drink}\n(${o.spec})`;
            aggregation[key] = (aggregation[key] || 0) + 1;
        });

        // æ¸²æŸ“åŒ¯ç¸½
        if (count > 0) {
            Object.keys(aggregation).sort().forEach(itemKey => {
                aggDiv.innerHTML += `
                    <div class="agg-item">
                        <div class="agg-name">${itemKey}</div>
                        <div class="agg-count">${aggregation[itemKey]}</div>
                    </div>`;
            });
        } else {
            aggDiv.innerHTML = '<p style="color: #999; text-align: center; margin-top: 20px;">å°šç„¡è¨‚å–® No orders.</p>';
        }

        document.getElementById('totalPrice').innerText = total;
        document.getElementById('count').innerText = `(${count}æ¯)`;
        document.getElementById('summaryOutput').innerText = count > 0 ? txt + `\nç¸½è¨ˆ: ${count}æ¯ / $${total}` : "ç›®å‰ç„¡è¨‚å–®è³‡æ–™";
    });

    window.copySummary = () => {
        navigator.clipboard.writeText(document.getElementById('summaryOutput').innerText);
        alert("çµ±è¨ˆæ–‡å­—å·²è¤‡è£½ï¼å·²å¯è²¼åˆ° LINE åˆ†äº«ã€‚");
    };
</script>
</body>
</html>
